<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KidCal â€“ Family Hub</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
  <script src="shared-utils.js"></script>

  <style>
    html {
      scroll-behavior: smooth;
    }
    /* Accessible Focus States */
    :focus-visible {
      outline: 2px solid #6366f1; /* Indigo-500 */
      outline-offset: 4px;
    }
    /* Utility to hide content until Custom Elements are defined to prevent FOUC */
    body:not(:defined) {
      opacity: 0;
      transition: opacity 0.2s ease-in;
    }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-900 via-slate-950 to-black text-white opacity-100 transition-opacity duration-300">

  <custom-navbar></custom-navbar>

  <main class="container mx-auto px-4 py-8 max-w-6xl">
    
    <header class="mb-8 space-y-2">
      <p class="text-xs font-semibold tracking-wide text-indigo-400 uppercase">
        Family Hub Â· Schedule Hub
      </p>
      <h1 class="text-3xl md:text-4xl font-extrabold text-slate-50">
        Tonight's focus: family and schedule.
      </h1>
      <p class="text-sm md:text-base text-slate-300 max-w-2xl">
        Use this board as your launchpad for school events, activities, quick views
        into KidCal, and jumps into your other project hubs.
      </p>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      
      <section class="lg:col-span-2 space-y-6" aria-label="Family overview and hubs">

        <article class="bg-slate-900/80 backdrop-blur rounded-2xl shadow-lg border border-slate-800 p-6">
          <div class="flex items-center justify-between gap-4 mb-4">
            <h2 class="text-2xl font-bold text-indigo-300 flex items-center gap-2">
              <i data-feather="calendar"></i>
              <span>Family Schedule Overview</span>
            </h2>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="family-calendar"></div>
        </article>

        <article class="bg-slate-900/80 backdrop-blur rounded-2xl shadow-lg border border-slate-800 p-6">
          <h2 class="text-2xl font-bold text-indigo-300 mb-4 flex items-center gap-2">
            <i data-feather="users"></i>
            <span>Family Members</span>
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="family-members"></div>
        </article>

        <article class="bg-slate-900/80 backdrop-blur rounded-2xl shadow-lg border border-slate-800 p-6">
          <h2 class="text-2xl font-bold text-indigo-300 mb-4 flex items-center gap-2">
            <i data-feather="grid"></i>
            <span>Hubs & Projects</span>
          </h2>
          <p class="text-xs text-slate-400 mb-3">
            High-level view of your active hubs. Click through to jump into details.
          </p>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="hubs-projects"></div>
        </article>

      </section>

      <aside class="space-y-6">

        <!-- Weather Widget -->
        <div class="bg-slate-900/80 backdrop-blur rounded-2xl shadow-lg border border-slate-800 p-6">
          <h2 class="text-xl font-bold text-sky-300 mb-4 flex items-center gap-2">
            <i data-feather="cloud"></i>
            <span>Weather</span>
          </h2>
          <div id="weather-widget"></div>
        </div>

        <div class="bg-slate-900/80 backdrop-blur rounded-2xl shadow-lg border border-slate-800 p-6">
          <h2 class="text-xl font-bold text-indigo-300 mb-4 flex items-center gap-2">
            <i data-feather="zap"></i>
            <span>Quick Actions</span>
          </h2>
          <nav class="space-y-3" aria-label="Quick actions">
            <a href="life-hub.html" class="w-full flex items-center gap-2 bg-indigo-600/30 hover:bg-indigo-500/40 text-indigo-200 font-medium py-2 px-4 rounded-lg transition group">
              <i data-feather="cpu" class="group-hover:scale-110 transition-transform"></i>
              <span>Life Hub</span>
            </a>

            <a href="https://chatgpt.com/g/g-p-69321305b5688191a65ef3972ff1a42d-document-scan-hub/project"
               target="_blank"
               rel="noopener noreferrer"
               class="w-full flex items-center gap-2 bg-emerald-600/30 hover:bg-emerald-500/40 text-emerald-200 font-medium py-2 px-4 rounded-lg transition group">
              <i data-feather="plus" class="group-hover:scale-110 transition-transform"></i>
              <span>Add New Event</span>
            </a>

            <button onclick="toggleGroceryModal()" class="w-full flex items-center gap-2 bg-purple-600/30 hover:bg-purple-500/40 text-purple-200 font-medium py-2 px-4 rounded-lg transition group">
              <i data-feather="shopping-cart" class="group-hover:scale-110 transition-transform"></i>
              <span>Grocery List</span>
            </button>
            <button onclick="toggleNotesModal()" class="w-full flex items-center gap-2 bg-amber-600/30 hover:bg-amber-500/40 text-amber-200 font-medium py-2 px-4 rounded-lg transition group">
              <i data-feather="file-text" class="group-hover:scale-110 transition-transform"></i>
              <span>Family Notes</span>
            </button>
          </nav>
        </div>

        <div class="bg-slate-900/80 backdrop-blur rounded-2xl shadow-lg border border-slate-800 p-6">
          <h2 class="text-xl font-bold text-indigo-300 mb-4 flex items-center gap-2">
            <i data-feather="bell"></i>
            <span>Upcoming Reminders</span>
          </h2>
          <div class="space-y-3" id="reminders"></div>
        </div>

        <!-- Quick Notes Preview -->
        <div class="bg-slate-900/80 backdrop-blur rounded-2xl shadow-lg border border-slate-800 p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-amber-300 flex items-center gap-2">
              <i data-feather="edit-3"></i>
              <span>Quick Notes</span>
            </h2>
            <button onclick="toggleNotesModal()" class="text-xs text-slate-400 hover:text-white">View All</button>
          </div>
          <div id="notes-preview" class="space-y-2"></div>
        </div>

      </aside>
    </div>
  </main>

  <custom-footer></custom-footer>

  <script>
    /**
     * Master Utility Class
     * Handles date formatting and global helpers
     */
    const Utils = {
      // Create a formatter for dates (e.g., "Fri Â· Dec 5")
      formatDate: (dateObj) => {
        return new Intl.DateTimeFormat('en-US', {
          weekday: 'short',
          month: 'short',
          day: 'numeric'
        }).format(dateObj).replace(',', ' Â·');
      },
      // Safely re-initialize icons in a specific container
      refreshIcons: (container = document) => {
        if (window.feather) feather.replace({}, container);
      }
    };

    /**
     * 1. CUSTOM ELEMENTS
     */
    class CustomNavbar extends HTMLElement {
      connectedCallback() {
        this.innerHTML = `
          <header class="sticky top-0 z-30 bg-slate-950/80 backdrop-blur border-b border-slate-800" role="banner">
            <nav class="container mx-auto px-4 py-3 max-w-6xl flex items-center justify-between gap-4">
              <div class="flex items-center gap-2">
                <span class="inline-flex items-center justify-center w-8 h-8 rounded-lg bg-indigo-600/20 border border-indigo-500/40">
                  <i data-feather="calendar" class="w-4 h-4 text-indigo-300"></i>
                </span>
                <div class="leading-tight">
                  <p class="text-xs text-slate-400 uppercase tracking-wide">System Core</p>
                  <p class="text-sm font-semibold text-slate-100">KidCal Â· Family Hub</p>
                </div>
              </div>
              <div class="hidden md:flex items-center gap-3 text-xs">
                <button onclick="Search.open()" class="px-3 py-1 rounded-full bg-slate-900/40 border border-slate-700 text-slate-300 hover:bg-slate-800/60 transition flex items-center gap-2">
                  <i data-feather="search" class="w-3 h-3"></i><span>Search</span>
                  <kbd class="text-[10px] px-1.5 py-0.5 bg-slate-800 rounded">âŒ˜K</kbd>
                </button>
                <a href="#hubs-projects" class="px-3 py-1 rounded-full bg-slate-900/40 border border-slate-700 text-slate-300 hover:bg-slate-800/60 transition flex items-center gap-1">
                  <i data-feather="grid" class="w-3 h-3"></i><span>Hubs</span>
                </a>
                <button onclick="Theme.toggle(); location.reload();" class="px-3 py-1 rounded-full bg-slate-900/40 border border-slate-700 text-slate-300 hover:bg-slate-800/60 transition flex items-center gap-1">
                  <i data-feather="moon" class="w-3 h-3"></i>
                </button>
                <a href="https://calendar.google.com" target="_blank" rel="noreferrer" class="px-3 py-1 rounded-full bg-indigo-600 text-xs font-semibold text-white hover:bg-indigo-500 transition flex items-center gap-1">
                  <i data-feather="external-link" class="w-3 h-3"></i><span>Google Calendar</span>
                </a>
              </div>
            </nav>
          </header>
        `;
        Utils.refreshIcons(this);
      }
    }

    class CustomFooter extends HTMLElement {
      connectedCallback() {
        this.innerHTML = `
          <footer class="mt-8 border-t border-slate-800 bg-slate-950/80" role="contentinfo">
            <div class="container mx-auto px-4 py-4 max-w-6xl flex flex-col md:flex-row items-center justify-between gap-2">
              <p class="text-[11px] text-slate-500">Family Hub Â· KidCal View Â· v1.1.0 (Stable)</p>
              <p class="text-[11px] text-slate-500 flex items-center gap-1">
                <i data-feather="info" class="w-3 h-3"></i>
                <span>Use this as read-only control center. Edit data in your System Core docs.</span>
              </p>
            </div>
          </footer>
        `;
        Utils.refreshIcons(this);
      }
    }

    customElements.define("custom-navbar", CustomNavbar);
    customElements.define("custom-footer", CustomFooter);


    /**
     * 2. DATA LAYER
     */
    const today = new Date();
    const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1);
    const nextWeek = new Date(today); nextWeek.setDate(today.getDate() + 5);

    const appData = {
      calendar: [
        { dayLabel: "Today", dateLabel: Utils.formatDate(today), title: "Kids arrive from Mom's", time: "6:00 AM", person: "Family", location: "Home", type: "home" },
        { dayLabel: "Today", dateLabel: Utils.formatDate(today), title: "7th Grade Bake Sale", time: "4:45â€“8:15 PM", person: "Cole", location: "Franklin St", type: "school" },
        { dayLabel: "Tomorrow", dateLabel: Utils.formatDate(tomorrow), title: "House reset + groceries", time: "Flexible", person: "Family", location: "Home / Walmart", type: "home" },
        { dayLabel: "Next Week", dateLabel: Utils.formatDate(nextWeek), title: "Dance class", time: "5:45â€“6:30 PM", person: "Lily", location: "Dance studio", type: "activity" }
      ],
      members: [
        { name: "Doug", role: "Dad Â· HQ", notes: "Master schedule, rides, budget.", emoji: "ðŸ§ " },
        { name: "Cole", role: "7th grade", notes: "Drone soccer, school events.", emoji: "ðŸŽ®" },
        { name: "Lily", role: "4th grade", notes: "Dance, Girl Scouts, concerts.", emoji: "ðŸ©°" },
        { name: "Dogs", role: "Chaos crew", notes: "Walks before dark, food, meds.", emoji: "ðŸ¾" }
      ],
      reminders: [
        { title: "Confirm bake sale items", time: "Today Â· before 3:00 PM", detail: "Bake & package, label any allergens." },
        { title: "Check school email", time: "Tonight Â· 9:00 PM", detail: "Scan for concerts, half-days, trips." },
        { title: "Update Google Calendar", time: "Tonight Â· 9:15 PM", detail: "Add any new dates and set reminders." }
      ],
      hubs: [
        { name: "KidCal Integration", hub: "Family Hub", status: "Active", detail: "School, dance, activities â†’ G-Cal.", link: "#", icon: "calendar" },
        { name: "Ticket Workflow", hub: "Work Hub", status: "In progress", detail: "IssueTrak SOPs.", link: "#", icon: "tool" },
        { name: "Vehicle Purchase", hub: "Automotive Hub", status: "Planning", detail: "Target payment â‰¤ $260/mo.", link: "#", icon: "truck" },
        { name: "Holiday Prep", hub: "Family Hub", status: "Time-sensitive", detail: "Bake sale, tree, meals.", link: "#", icon: "gift" },
        { name: "Debt Management", hub: "Finance Hub", status: "Active", detail: "Prioritize high-interest debts.", link: "#", icon: "trending-down" },
        { name: "Academic Progress", hub: "Academic Hub", status: "Ongoing", detail: "PSYC103 + ENGL100.", link: "#", icon: "book-open" },
        { name: "Legal / Custody", hub: "Legal Hub", status: "Tracked", detail: "Custody modification.", link: "#", icon: "file-text" },
        { name: "Self-Care", hub: "Emotional Hub", status: "Support", detail: "Sleep, music, exercise.", link: "#", icon: "heart" }
      ]
    };


    /**
     * 3. RENDERING ENGINE
     */
    
    // Style Generators
    const getBadgeStyle = (type) => {
      const map = {
        school: "bg-indigo-500/20 text-indigo-200 border-indigo-500/40",
        activity: "bg-emerald-500/20 text-emerald-200 border-emerald-500/40",
        home: "bg-slate-500/20 text-slate-200 border-slate-500/40"
      };
      return map[type] || map.home;
    };

    const getStatusStyle = (status) => {
      const map = {
        "Active": "bg-emerald-500/20 text-emerald-200 border-emerald-500/40",
        "Time-sensitive": "bg-red-500/20 text-red-200 border-red-500/40",
        "In progress": "bg-amber-500/20 text-amber-200 border-amber-500/40",
        "Support": "bg-pink-500/20 text-pink-200 border-pink-500/40"
      };
      return map[status] || "bg-slate-500/20 text-slate-200 border-slate-500/40";
    };

    // Render Functions
    const renderCalendar = () => {
      const html = appData.calendar.map(item => `
        <article class="bg-slate-950/60 border border-slate-800 rounded-xl p-4 flex flex-col gap-2 hover:border-slate-700 transition">
          <div class="flex items-center justify-between gap-2">
            <div>
              <p class="text-xs uppercase tracking-wide text-slate-400">${item.dayLabel}</p>
              <p class="text-sm font-semibold text-slate-100">${item.dateLabel}</p>
            </div>
            <span class="text-[11px] px-2 py-1 rounded-full border ${getBadgeStyle(item.type)} capitalize">
              ${item.type}
            </span>
          </div>
          <h3 class="text-base font-semibold text-indigo-100">${item.title}</h3>
          <div class="mt-auto space-y-1">
            <p class="text-xs text-slate-300"><span class="font-medium text-slate-500">Time:</span> ${item.time}</p>
            <p class="text-xs text-slate-300"><span class="font-medium text-slate-500">Who:</span> ${item.person}</p>
            <p class="text-xs text-slate-400 flex items-center gap-1">
              <i data-feather="map-pin" class="w-3 h-3"></i><span>${item.location}</span>
            </p>
          </div>
        </article>
      `).join('');
      document.getElementById('family-calendar').innerHTML = html;
    };

    const renderMembers = () => {
      const html = appData.members.map(m => `
        <article class="bg-slate-950/60 border border-slate-800 rounded-xl p-4 flex flex-col gap-2 hover:border-slate-700 transition">
          <div class="flex items-center gap-3">
            <span class="text-2xl" role="img" aria-label="${m.name}">${m.emoji}</span>
            <div>
              <h3 class="text-base font-semibold text-slate-50">${m.name}</h3>
              <p class="text-xs text-slate-400">${m.role}</p>
            </div>
          </div>
          <p class="text-xs text-slate-300 mt-2">${m.notes}</p>
        </article>
      `).join('');
      document.getElementById('family-members').innerHTML = html;
    };

    const renderHubs = () => {
      const html = appData.hubs.map(h => `
        <article class="bg-slate-950/60 border border-slate-800 rounded-xl p-4 flex flex-col gap-2 group hover:border-indigo-500/50 transition">
          <div class="flex items-center justify-between gap-2 mb-1">
            <div class="flex items-center gap-2">
              <div class="w-7 h-7 rounded-lg bg-slate-900 flex items-center justify-center border border-slate-700 group-hover:border-indigo-500/50 transition">
                <i data-feather="${h.icon}" class="w-3.5 h-3.5 text-indigo-300"></i>
              </div>
              <div>
                <h3 class="text-sm font-semibold text-slate-50">${h.name}</h3>
                <p class="text-[11px] text-slate-400">${h.hub}</p>
              </div>
            </div>
            <span class="text-[11px] px-2 py-1 rounded-full border ${getStatusStyle(h.status)}">
              ${h.status}
            </span>
          </div>
          <p class="text-xs text-slate-300 mb-1 line-clamp-2">${h.detail}</p>
          <a href="${h.link}" class="mt-auto inline-flex items-center gap-1 text-[11px] text-indigo-300 hover:text-indigo-200 transition">
            <span>Open hub</span><i data-feather="arrow-right" class="w-3 h-3"></i>
          </a>
        </article>
      `).join('');
      document.getElementById('hubs-projects').innerHTML = html;
    };

    const renderReminders = () => {
      const html = appData.reminders.map(r => `
        <article class="bg-slate-950/60 border border-slate-800 rounded-xl p-3 flex flex-col gap-1 hover:bg-slate-900 transition cursor-pointer">
          <div class="flex items-center justify-between gap-2">
            <h3 class="text-sm font-semibold text-slate-50">${r.title}</h3>
          </div>
          <p class="text-xs text-slate-300">${r.detail}</p>
          <p class="text-[11px] text-amber-300 flex items-center gap-1 mt-1">
            <i data-feather="clock" class="w-3 h-3"></i><span>${r.time}</span>
          </p>
        </article>
      `).join('');
      document.getElementById('reminders').innerHTML = html;
    };

    // Weather Widget Render
    const renderWeather = () => {
      const weather = Weather.getData();
      const html = `
        <div class="flex items-center justify-between mb-4">
          <div>
            <p class="text-4xl font-bold text-white">${weather.temp}Â°F</p>
            <p class="text-sm text-slate-400">${weather.condition}</p>
          </div>
          <i data-feather="${weather.icon}" class="w-12 h-12 text-sky-400"></i>
        </div>
        <div class="grid grid-cols-3 gap-2 text-center mb-4">
          <div class="bg-slate-800/50 rounded-lg p-2">
            <p class="text-[10px] text-slate-500">HIGH</p>
            <p class="text-sm font-bold text-white">${weather.high}Â°</p>
          </div>
          <div class="bg-slate-800/50 rounded-lg p-2">
            <p class="text-[10px] text-slate-500">LOW</p>
            <p class="text-sm font-bold text-white">${weather.low}Â°</p>
          </div>
          <div class="bg-slate-800/50 rounded-lg p-2">
            <p class="text-[10px] text-slate-500">WIND</p>
            <p class="text-sm font-bold text-white">${weather.wind}mph</p>
          </div>
        </div>
        <div class="flex justify-between">
          ${weather.forecast.map(f => `
            <div class="text-center">
              <p class="text-[10px] text-slate-500">${f.day}</p>
              <i data-feather="${f.icon}" class="w-4 h-4 mx-auto my-1 text-slate-400"></i>
              <p class="text-xs text-white">${f.high}Â°</p>
            </div>
          `).join('')}
        </div>
      `;
      document.getElementById('weather-widget').innerHTML = html;
    };

    // Notes Preview Render
    const renderNotesPreview = () => {
      const notes = Notes.getNotes().slice(0, 3);
      const container = document.getElementById('notes-preview');
      if (notes.length === 0) {
        container.innerHTML = `<p class="text-sm text-slate-500 text-center py-4">No notes yet. Click "Family Notes" to add one.</p>`;
      } else {
        container.innerHTML = notes.map(n => `
          <div class="p-2 bg-slate-800/50 rounded-lg">
            <p class="text-xs text-slate-300 line-clamp-2">${n.content}</p>
            <p class="text-[10px] text-slate-500 mt-1">${new Date(n.createdAt).toLocaleDateString()}</p>
          </div>
        `).join('');
      }
    };

    // Grocery List Modal
    let groceryModalOpen = false;
    const toggleGroceryModal = () => {
      groceryModalOpen = !groceryModalOpen;
      let modal = document.getElementById('grocery-modal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'grocery-modal';
        document.body.appendChild(modal);
      }
      if (groceryModalOpen) {
        renderGroceryModal();
        modal.classList.remove('hidden');
      } else {
        modal.classList.add('hidden');
      }
    };

    const renderGroceryModal = () => {
      const items = GroceryList.getItems();
      const modal = document.getElementById('grocery-modal');
      modal.className = 'fixed inset-0 z-50 flex items-center justify-center';
      modal.innerHTML = `
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="toggleGroceryModal()"></div>
        <div class="relative w-full max-w-md mx-4 bg-slate-900 rounded-2xl border border-slate-700 shadow-2xl">
          <div class="flex items-center justify-between p-4 border-b border-slate-700">
            <h3 class="text-lg font-bold text-purple-300 flex items-center gap-2">
              <i data-feather="shopping-cart" class="w-5 h-5"></i>
              Grocery List
            </h3>
            <button onclick="toggleGroceryModal()" class="text-slate-400 hover:text-white">
              <i data-feather="x" class="w-5 h-5"></i>
            </button>
          </div>
          <div class="p-4">
            <div class="flex gap-2 mb-4">
              <input type="text" id="grocery-input" placeholder="Add item..."
                class="flex-1 bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white placeholder-slate-500 focus:outline-none focus:border-purple-500"
                onkeypress="if(event.key==='Enter') addGroceryItem()">
              <button onclick="addGroceryItem()" class="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg text-sm">Add</button>
            </div>
            <div class="max-h-64 overflow-y-auto space-y-2" id="grocery-items">
              ${items.length === 0 ? '<p class="text-center text-slate-500 py-8">No items yet</p>' : items.map(item => `
                <div class="flex items-center gap-3 p-2 rounded-lg ${item.checked ? 'bg-slate-800/30' : 'bg-slate-800/50'} group">
                  <input type="checkbox" ${item.checked ? 'checked' : ''} onchange="toggleGroceryItem(${item.id})"
                    class="w-4 h-4 bg-slate-700 border-slate-600 rounded text-purple-500 focus:ring-purple-500">
                  <span class="flex-1 text-sm ${item.checked ? 'text-slate-500 line-through' : 'text-slate-300'}">${item.text}</span>
                  <button onclick="removeGroceryItem(${item.id})" class="text-slate-600 hover:text-red-400 opacity-0 group-hover:opacity-100">
                    <i data-feather="trash-2" class="w-4 h-4"></i>
                  </button>
                </div>
              `).join('')}
            </div>
            ${items.some(i => i.checked) ? `
              <button onclick="clearCheckedGroceries()" class="w-full mt-4 py-2 text-sm text-slate-400 hover:text-white border border-slate-700 rounded-lg">
                Clear Checked Items
              </button>
            ` : ''}
          </div>
        </div>
      `;
      if (window.feather) feather.replace();
    };

    const addGroceryItem = () => {
      const input = document.getElementById('grocery-input');
      if (input.value.trim()) {
        GroceryList.addItem(input.value.trim());
        input.value = '';
        renderGroceryModal();
        Notifications.success('Item added to grocery list');
      }
    };

    const toggleGroceryItem = (id) => {
      GroceryList.toggleItem(id);
      renderGroceryModal();
    };

    const removeGroceryItem = (id) => {
      GroceryList.removeItem(id);
      renderGroceryModal();
    };

    const clearCheckedGroceries = () => {
      GroceryList.clearChecked();
      renderGroceryModal();
      Notifications.info('Checked items cleared');
    };

    // Notes Modal
    let notesModalOpen = false;
    const toggleNotesModal = () => {
      notesModalOpen = !notesModalOpen;
      let modal = document.getElementById('notes-modal');
      if (!modal) {
        modal = document.createElement('div');
        modal.id = 'notes-modal';
        document.body.appendChild(modal);
      }
      if (notesModalOpen) {
        renderNotesModal();
        modal.classList.remove('hidden');
      } else {
        modal.classList.add('hidden');
        renderNotesPreview();
      }
    };

    const renderNotesModal = () => {
      const notes = Notes.getNotes();
      const modal = document.getElementById('notes-modal');
      modal.className = 'fixed inset-0 z-50 flex items-center justify-center';
      modal.innerHTML = `
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" onclick="toggleNotesModal()"></div>
        <div class="relative w-full max-w-lg mx-4 bg-slate-900 rounded-2xl border border-slate-700 shadow-2xl">
          <div class="flex items-center justify-between p-4 border-b border-slate-700">
            <h3 class="text-lg font-bold text-amber-300 flex items-center gap-2">
              <i data-feather="file-text" class="w-5 h-5"></i>
              Family Notes
            </h3>
            <button onclick="toggleNotesModal()" class="text-slate-400 hover:text-white">
              <i data-feather="x" class="w-5 h-5"></i>
            </button>
          </div>
          <div class="p-4">
            <div class="mb-4">
              <textarea id="note-input" placeholder="Write a new note..."
                class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-sm text-white placeholder-slate-500 focus:outline-none focus:border-amber-500 resize-none" rows="3"></textarea>
              <button onclick="addNote()" class="mt-2 px-4 py-2 bg-amber-600 hover:bg-amber-500 text-white rounded-lg text-sm">Save Note</button>
            </div>
            <div class="max-h-64 overflow-y-auto space-y-3" id="notes-list">
              ${notes.length === 0 ? '<p class="text-center text-slate-500 py-8">No notes yet</p>' : notes.map(note => `
                <div class="p-3 bg-slate-800/50 rounded-lg group">
                  <p class="text-sm text-slate-300 whitespace-pre-wrap">${note.content}</p>
                  <div class="flex justify-between items-center mt-2">
                    <p class="text-[10px] text-slate-500">${new Date(note.createdAt).toLocaleString()}</p>
                    <button onclick="deleteNote(${note.id})" class="text-slate-600 hover:text-red-400 opacity-0 group-hover:opacity-100">
                      <i data-feather="trash-2" class="w-4 h-4"></i>
                    </button>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
      if (window.feather) feather.replace();
    };

    const addNote = () => {
      const input = document.getElementById('note-input');
      if (input.value.trim()) {
        Notes.addNote(input.value.trim());
        input.value = '';
        renderNotesModal();
        Notifications.success('Note saved');
      }
    };

    const deleteNote = (id) => {
      Notes.deleteNote(id);
      renderNotesModal();
      Notifications.info('Note deleted');
    };

    // Initialize Application
    document.addEventListener("DOMContentLoaded", () => {
      renderCalendar();
      renderMembers();
      renderHubs();
      renderReminders();
      renderWeather();
      renderNotesPreview();

      Utils.refreshIcons();
    });

  </script>
</body>
</html>